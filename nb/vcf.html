<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lavinia I Fechete, Stig U Andersen, Mikkel H Schierup, Samuele Soraggi">

<title>Introduction to NGS data analysis - Variant Calling and VCF processing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EXW13D5861"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EXW13D5861', { 'anonymize_ip': true});
</script>
<script type="application/ld+json">
  {
    "@context": "https://schema.org/",
    "@type": "LearningResource",
    "@id": "https://hds-sandbox.github.io/NGS_summer_course_Aarhus/",
    "dct:conformsTo": {
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
        "@type": "CreativeWork"
      }
    },
    "name": "Introduction to NGS data analysis",
    "description": "A one-week summer school which provides an overview of current NGS technologies and directions in which these are currently progressing. Methods for assembling genomes from NGS data using either a reference genome or de novo assembly will be presented together with some emphasis on assessing NGS data quality (Quality control, accuracy of base calling). The course includes notebooks for the analysis of short- and long-read sequencing data, bulkRNA data and single-cell RNA sequencing data.",
    "keywords": [
      "single cell RNA",
      "NGS data",
      "genomics",
      "transcriptomics",
      "bulk RNA",
      "bioinformatics"
    ],
    "about": [
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/topic_0091",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "topic_0091",
        "name": "bioinformatics",
        "url": "https://bioportal.bioontology.org/ontologies/EDAM/?p=classes&conceptid=http%3A%2F%2Fedamontology.org%2Ftopic_0091"
      },
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/data_3670",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "data_3670",
        "name": "Online course",
        "url": "https://bioportal.bioontology.org/ontologies/EDAM/?p=classes&conceptid=http%3A%2F%2Fedamontology.org%2Fdata_3670"
      },
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/topic_0622",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "topic_0622",
        "name": "Genomics",
        "url": "https://www.ebi.ac.uk/ols4/ontologies/edam/classes/http%253A%252F%252Fedamontology.org%252Ftopic_0622"
      },
      {
        "@type": "DefinedTerm",
        "@id": "http://edamontology.org/topic_3308",
        "inDefinedTermSet": "http://edamontology.org",
        "termCode": "topic_3308",
        "name": "Transcriptomics",
        "url": "https://www.ebi.ac.uk/ols4/ontologies/edam/classes/http%253A%252F%252Fedamontology.org%252Ftopic_3308"
      }
    ],
    "abstract": "NGS technologies are fundamental in genomics and transcriptomics studies. In this course we set the foundations for the analysis of NGS data with various interactive exercises for genome alignment, genomics and transcriptome analysis. open source code, Slides and access information can be found at the webpage https://hds-sandbox.github.io/NGS_summer_course_Aarhus/.",
    "audience": [
      {
        "@type": "Audience",
        "audienceType": "Students"
      },
      {
        "@type": "Audience",
        "audienceType": "PhD students"
      },
      {
        "@type": "Audience",
        "audienceType": "Postdoctoral researchers"
      }
    ],
    "competencyRequired": [
      "Basic biology programming",
      "Basic python/R/bash programming (an advantage but not mandatory)",
      "Machine learning basics for bioinformatics (PCA, statistical testing)"
    ],
    "inLanguage": ["en-US"],
    "learningResourceType": ["tutorials"],
    "license": "https://spdx.org/licenses/CC-BY-4.0.html",
    "url": "https://hds-sandbox.github.io/NGS_summer_course_Aarhus/",
    "citation": [
        {
            "@type": "CreativeWork",
            "@id": "https://doi.org/10.5281/zenodo.8074603"
        } ],
     "funding":[
     	  {
            "@type": "Grant",
            "@id": "NNF grant number NNF20OC0063268"        	
        }
     ]
  }
</script>


<meta property="og:title" content="Introduction to NGS data analysis - Variant Calling and VCF processing">
<meta property="og:description" content="">
<meta property="og:site_name" content="Introduction to NGS data analysis">
<meta property="og:locale" content="en_US">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/NGSlogo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Introduction to NGS data analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../slides.html"> 
<span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-access" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Access</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-access">    
        <li>
    <a class="dropdown-item" href="../access/UCloud.html">
 <span class="dropdown-text">UCloud</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../access/genomedk.html">
 <span class="dropdown-text">GenomeDK</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../galaxy/galaxy.html"> 
<span class="menu-text">Galaxy</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../nb/align.html">
 <span class="dropdown-text">Alignment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../nb/vcf.html">
 <span class="dropdown-text">Variant analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../nb/bulk.html">
 <span class="dropdown-text">bulkRNA analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../nb/scrna.html">
 <span class="dropdown-text">scRNA analysis</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hds-sandbox"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#use-the-bam-files-generated-from-the-alignment-of-raw-reads" id="toc-use-the-bam-files-generated-from-the-alignment-of-raw-reads" class="nav-link active" data-scroll-target="#use-the-bam-files-generated-from-the-alignment-of-raw-reads">Use the <code>bam</code> files generated from the alignment of raw reads</a></li>
  <li><a href="#variant-calling" id="toc-variant-calling" class="nav-link" data-scroll-target="#variant-calling">Variant calling</a>
  <ul class="collapse">
  <li><a href="#call-subgenome-snps-using-the-hifi-alignments-and-the-reference-genome" id="toc-call-subgenome-snps-using-the-hifi-alignments-and-the-reference-genome" class="nav-link" data-scroll-target="#call-subgenome-snps-using-the-hifi-alignments-and-the-reference-genome">Call subgenome SNPs using the Hifi alignments and the reference genome</a></li>
  <li><a href="#call-snps-using-the-two-rna-seq-genotypes-s10-and-ti" id="toc-call-snps-using-the-two-rna-seq-genotypes-s10-and-ti" class="nav-link" data-scroll-target="#call-snps-using-the-two-rna-seq-genotypes-s10-and-ti">Call SNPs using the two RNA-seq genotypes, S10 and Ti</a></li>
  </ul></li>
  <li><a href="#vcf-files-processing-and-filtering" id="toc-vcf-files-processing-and-filtering" class="nav-link" data-scroll-target="#vcf-files-processing-and-filtering">VCF files processing and filtering</a></li>
  <li><a href="#genotypes-counting" id="toc-genotypes-counting" class="nav-link" data-scroll-target="#genotypes-counting">Genotypes counting</a></li>
  <li><a href="#comparison-of-vcf-files" id="toc-comparison-of-vcf-files" class="nav-link" data-scroll-target="#comparison-of-vcf-files">Comparison of VCF files</a></li>
  <li><a href="#wrapping-up" id="toc-wrapping-up" class="nav-link" data-scroll-target="#wrapping-up">Wrapping up üéâ üéâ üéâ</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Variant Calling and VCF processing</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lavinia I Fechete, Stig U Andersen, Mikkel H Schierup, Samuele Soraggi </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>This tutorial will cover the steps for performing Variant calling and working on the resulting VCF file format. We will be using the Hifi and RNA-seq mapping data obtained from Galaxy. At the end of this tutorial you will be able to:</p>
<div style="background-color:rgba(0, 128, 0, 0.3); text-align:left; vertical-align: left; padding:40px 0;">
<ul>
<li>call variants using alignment files</li>
<li>extract data from <code>VCF</code> files using <code>Python</code></li>
<li>filter and count variants</li>
</ul>
</div>
<p><br> <br></p>
<p>The present tutorial, like the rest of the course material, is available at our <a href="https://github.com/hds-sandbox/NGS_summer_course_Aarhus">open-source github repository</a>.&nbsp;</p>
<p>To use this notebook, use the <code>NGS (python)</code> kernel that contains the packages. Choose it by selecting <code>Kernel -&gt; Change Kernel</code> in the menu on top of the window.</p>
<details>
<summary>
<b>A few introductory points to run this notebook (click to show):</b>
</summary>
<ul>
<li>To use this notebook, use the <code>NGS (python)</code> kernel that contains the packages. Choose it by selecting <code>Kernel -&gt; Change Kernel</code> in the menu on top of the window.</li>
</ul>
<figure class="figure">
<img src="images/kernelchoice.png" width="500" alt="Kernel Choice" class="center figure-img">
</figure>
<ul>
<li>In this notebook you will use both bash and python commands</li>
<li>On some computers, you might see the result of the commands once they are done running. This means you will wait some time while the computer is crunching, and only afterwards you will see the result of the command you have executed</li>
<li>You can run the code in each cell by clicking on the run cell button, or by pressing <kbd> Shift </kbd> + <kbd> Enter </kbd>. When the code is done running, a small green check sign will appear on the left side</li>
<li>You need to run the cells in sequential order, please do not run a cell until the one above finished running and do not skip any cells</li>
<li>Each cell contains a short description of the code and the output you should get. Please try not to focus on understanding the code for each command in too much detail, but rather try to focus on the output</li>
<li>You can create new code cells by pressing <kbd> + </kbd> in the Menu bar above.</li>
</ul>
</details>
<p><br> <br></p>
<p>Import the necessary Python libraries:</p>
<div id="cell-3" class="cell" data-tags="[]" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> allel</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some of the commands used in the course are functions we implement to simplify reading the code of this course. Mostly, those are commands requiring lines of code that would not add anything to your learning curve (management of plots, trivial calculations, few management of the notebook layout). However, you are free to look at the code into the file <code>Scripts/pythonScripts.py</code> and to reuse our code in your own work (citing our course).</p>
<div id="cell-5" class="cell" data-tags="[]" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>run ..<span class="op">/</span>Scripts<span class="op">/</span>pythonScripts.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a folder for the data necessary to VCF data analysis</p>
<div id="cell-7" class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p Data_for_VCF_analysis</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="use-the-bam-files-generated-from-the-alignment-of-raw-reads" class="level1">
<h1>Use the <code>bam</code> files generated from the alignment of raw reads</h1>
<p>We will use the data created during the alignment session of the course. You had two possibilities:</p>
<ul>
<li><p>using the interactive <code>Galaxy</code> platform as explained in <a href="https://hds-sandbox.github.io/NGS_summer_course_Aarhus/">the course webpage</a>. In this case you will need to upload the some of the created data into the folder <code>Data_for_VCF_analysis</code>, renaming the files as follows:</p>
<ul>
<li>Hifi reads mapped to Contig1: <code>HIFI_contig_1.bam</code></li>
<li>Hifi reads mapped to Contig2: <code>HIFI_contig_2.bam</code></li>
<li>Hifi reads mapped to Contig 1 and 2: <code>HIFI_contig_1_2_asm20.bam</code> (you can of course choose the one with the <code>map-pb</code> alignment option from the alignment notebook)</li>
<li>S10 RNAseq reads mapped to Contig 1 and 2 (After merging the bam files): <code>RNA_S10_merged.bam</code></li>
<li>Ti RNAseq reads mapped to Contig 1 and 2 (After merging the bam files): <code>RNA_TI_merged.bam</code></li>
</ul></li>
<li><p>using the notebook <code>01_align.ipynb</code>. In that case, you just need to run the command below, linking the data in the <code>results</code> folder into the folder <code>Data_for_VCF_analysis</code>.</p></li>
</ul>
<div id="cell-10" class="cell" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ln <span class="op">-</span>fs `realpath results<span class="op">/</span>HIFI_alignment<span class="op">/</span>PacBio_clover_alignment_1.sort.bam` Data_for_VCF_analysis<span class="op">/</span>HIFI_contig_1.bam</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ln <span class="op">-</span>fs `realpath results<span class="op">/</span>HIFI_alignment<span class="op">/</span>PacBio_clover_alignment_2.sort.bam` Data_for_VCF_analysis<span class="op">/</span>HIFI_contig_2.bam</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ln <span class="op">-</span>fs `realpath results<span class="op">/</span>HIFI_alignment<span class="op">/</span>PacBio_clover_alignment_1_2_asm20.sort.bam` Data_for_VCF_analysis<span class="op">/</span>HIFI_contig_1_2.bam</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>ln <span class="op">-</span>fs `realpath results<span class="op">/</span>STAR_output<span class="op">/</span>S10_align_contigs_1_2_merge<span class="op">/</span>S10.<span class="bu">sorted</span>.bam` Data_for_VCF_analysis<span class="op">/</span>RNA_S10_merged.bam</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>ln <span class="op">-</span>fs `realpath results<span class="op">/</span>STAR_output<span class="op">/</span>TI_align_contigs_1_2_merge<span class="op">/</span>TI.<span class="bu">sorted</span>.bam` Data_for_VCF_analysis<span class="op">/</span>RNA_TI_merged.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="variant-calling" class="level1">
<h1>Variant calling</h1>
<p>We will use a tool named <code>bcftools</code> to find variants in the alignment files (<code>.bam</code>) relative to the reference genome, in this case, the file <code>DNA_Contig1_2.fasta</code>. In this way we can identify positions in the genome where the sequence of the aligned reads differ from the reference genome they were mapped to. There are multiple types of <strong>genetic variation</strong>, e.g.&nbsp;SNPs (single nucleotide polymorphism), indels (insertions or deletions) and structural variations (such as chromosomal rearrangements).</p>
<p>Here we will only be working with SNPs, thus we will use the terms <strong>variants</strong> and <strong>SNPs</strong> interchangeably. The called variants will be stored in a specific format file, the Variant Call Format (<code>VCF</code>). <br> When looking at an alignment files in IGV you should easily recognize the SNP positions. You can see in the figure below that at the marked positions all the mapped reads have a mismatch compared to the reference.</p>
<figure class="figure">
<img src="images/alignment.png" width="600" alt="Alignment on IGV" class="center figure-img">
</figure>
<p>You will be calling <strong>two types of SNPs</strong> in this notebook. First, we will find <strong>subgenome SNPs</strong> using the Hifi reads mapped to white clover Contig1 and Contig2. These are positions in the contigs that are different between the two subgenomes of white clover.</p>
<p>Secondly, we will find SNPs that differentiate between the sequenced white clover S10 (the reference genome) and Ti genotype, using RNA-seq read mapping.</p>
<p>Create a folder that will store all the files generated in this notebook.</p>
<div id="cell-15" class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p results<span class="op">/</span>VCF_Files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="call-subgenome-snps-using-the-hifi-alignments-and-the-reference-genome" class="level2">
<h2 class="anchored" data-anchor-id="call-subgenome-snps-using-the-hifi-alignments-and-the-reference-genome">Call subgenome SNPs using the Hifi alignments and the reference genome</h2>
<p>We will use the <code>bcftools</code> software to call SNPs from alignment files. <code>bcftools</code> is a toolkit for variant calling and manipulating VCF files. If you are interested, you can find all the functionalities here http://samtools.github.io/bcftools/bcftools.html#call.</p>
<p>We mainly need two commands for this step, first <code>bcftools mpileup</code> which takes as input the alignment and the genome reference files, followed by <code>bcftools call</code> to produce VCF files.</p>
<p>The cell below will generate 3 VCF files stored in the folder <code>results/VCF_Files</code> using the Hifi alignment files uploaded from Galaxy.</p>
<div id="cell-17" class="cell" data-outputid="67df6a82-cfd8-4741-e48c-2942c440b615" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools mpileup <span class="op">--</span>threads <span class="dv">4</span> <span class="op">-</span>Ou <span class="op">--</span>skip<span class="op">-</span>indels <span class="op">-</span>f ..<span class="op">/</span>Data<span class="op">/</span>Clover_Data<span class="op">/</span>DNA_Contig1_2.fasta Data_for_VCF_analysis<span class="op">/</span>HIFI_contig_1.bam <span class="op">|</span> bcftools call <span class="op">-</span>mv <span class="op">-</span>Ov <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1.vcf</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools mpileup <span class="op">--</span>threads <span class="dv">4</span> <span class="op">-</span>Ou <span class="op">--</span>skip<span class="op">-</span>indels <span class="op">-</span>f ..<span class="op">/</span>Data<span class="op">/</span>Clover_Data<span class="op">/</span>DNA_Contig1_2.fasta Data_for_VCF_analysis<span class="op">/</span>HIFI_contig_2.bam <span class="op">|</span> bcftools call <span class="op">-</span>mv <span class="op">-</span>Ov <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2.vcf</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools mpileup <span class="op">--</span>threads <span class="dv">4</span> <span class="op">-</span>Ou <span class="op">--</span>skip<span class="op">-</span>indels <span class="op">-</span>f ..<span class="op">/</span>Data<span class="op">/</span>Clover_Data<span class="op">/</span>DNA_Contig1_2.fasta Data_for_VCF_analysis<span class="op">/</span>HIFI_contig_1_2.bam <span class="op">|</span> bcftools call <span class="op">-</span>mv <span class="op">-</span>Ov <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_2.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Note: none of --samples-file, --ploidy or --ploidy-file given, assuming all sites are diploid
[mpileup] 1 samples in 1 input files
[mpileup] maximum number of reads per input file set to -d 250
Note: none of --samples-file, --ploidy or --ploidy-file given, assuming all sites are diploid
[mpileup] 1 samples in 1 input files
[mpileup] maximum number of reads per input file set to -d 250
Note: none of --samples-file, --ploidy or --ploidy-file given, assuming all sites are diploid
[mpileup] 1 samples in 1 input files
[mpileup] maximum number of reads per input file set to -d 250</code></pre>
</div>
</div>
<div class="alert-success">
<font size="+2"> <b> TASK </b> </font>
</div>
<ul>
<li>Inspect the VCF files using IGV, comparing them to the specific alignment BAM files. (You can download the VCF files to your computer from the <code>results/VCF_Files</code> folder)</li>
<li>Are there any problematic positions that may not represent true SNPs?</li>
<li>How can you use the HiFi reads aligned to Contigs1+2 identify potential problems?</li>
</ul>
<p><strong>Hint:</strong> Try scrolling to the ends of the contigs.</p>
</section>
<section id="call-snps-using-the-two-rna-seq-genotypes-s10-and-ti" class="level2">
<h2 class="anchored" data-anchor-id="call-snps-using-the-two-rna-seq-genotypes-s10-and-ti">Call SNPs using the two RNA-seq genotypes, S10 and Ti</h2>
<p>We will repeat the same step as above this time using the RNA-seq alignment files for the two white clover genotypes (S10 and Ti). These commands will produce another two VCF files, stored in the same folder.</p>
<div id="cell-20" class="cell" data-outputid="6b3396ba-7ab2-4101-f0a9-c1624d053135" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools mpileup <span class="op">--</span>threads <span class="dv">4</span> <span class="op">-</span>Ou <span class="op">--</span>skip<span class="op">-</span>indels <span class="op">-</span>f reference_data<span class="op">/</span>DNA_Contig1_2.fasta Data_for_VCF_analysis<span class="op">/</span>RNA_S10_merged.bam <span class="op">|</span> bcftools call <span class="op">-</span>mv <span class="op">-</span>Ov <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_S10_merged.vcf</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools mpileup <span class="op">--</span>threads <span class="dv">4</span> <span class="op">-</span>Ou <span class="op">--</span>skip<span class="op">-</span>indels <span class="op">-</span>f reference_data<span class="op">/</span>DNA_Contig1_2.fasta Data_for_VCF_analysis<span class="op">/</span>RNA_TI_merged.bam <span class="op">|</span> bcftools call <span class="op">-</span>mv <span class="op">-</span>Ov <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[mpileup] 1 samples in 1 input files
Note: none of --samples-file, --ploidy or --ploidy-file given, assuming all sites are diploid
[mpileup] maximum number of reads per input file set to -d 250
Note: none of --samples-file, --ploidy or --ploidy-file given, assuming all sites are diploid
[mpileup] 1 samples in 1 input files
[mpileup] maximum number of reads per input file set to -d 250</code></pre>
</div>
</div>
<div class="alert-success">
<font size="+2"> <b> TASK </b> </font>
</div>
<ul>
<li>Inspect one of the VCFs and the corresponding alignment files in IGV.</li>
<li>Is it relevant to filter for false positives in this case, and what parameters would you look further into?</li>
</ul>
</section>
</section>
<section id="vcf-files-processing-and-filtering" class="level1">
<h1>VCF files processing and filtering</h1>
<p>Take a look at what one of the previously generated VCF files contains by running the cell below.</p>
<p>A VCF file begins with the meta-information lines starting with <code>##</code> followed by one header line, starting with <code>#</code>. Next, there are the data lines, each describing a genetic variant for a certain position in the genome. Each data line contains multiple tab-delimited columns with information about the variant. There are 9 fixed columns, labelled ‚ÄúCHROM‚Äù, ‚ÄúPOS‚Äù, ‚ÄúID‚Äù, ‚ÄúREF‚Äù, ‚ÄúALT‚Äù, ‚ÄúQUAL‚Äù, ‚ÄúFILTER‚Äù, ‚ÄúINFO‚Äù and ‚ÄúFORMAT‚Äù. Find more about the content of those columns <a href="https://en.wikipedia.org/wiki/Variant_Call_Format">in this wikipedia page</a>.</p>
<p>In the sample column you can find the most likely genotype of the sample. For diploid organisms, there will be a 0 value for reference allele and 1 for the alternate allele.</p>
<figure class="figure">
<img src="images/vcf_genotype.png" width="700" alt="Possible genotypes in the data" class="center figure-img">
<figcaption>
Figure: possible genotypes in the data.
</figcaption>
</figure>
<p>For example, here we read the first 50 rows from the <code>RNAseq_S10_merged.vcf</code> file. You can see that the file format follows the same pattern as explained above.</p>
<div id="cell-27" class="cell" data-outputid="81f3b2e2-2795-4130-febe-54180d0577e9" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>cat results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_S10_merged.vcf <span class="op">|</span> head <span class="op">-</span><span class="dv">50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>##fileformat=VCFv4.2
##FILTER=&lt;ID=PASS,Description="All filters passed"&gt;
##bcftoolsVersion=1.16+htslib-1.17
##bcftoolsCommand=mpileup --threads 4 -Ou --skip-indels -f reference_data/DNA_Contig1_2.fasta Data_for_VCF_analysis/RNA_S10_merged.bam
##reference=file://reference_data/DNA_Contig1_2.fasta
##contig=&lt;ID=1,length=1031631&gt;
##contig=&lt;ID=2,length=1057923&gt;
##ALT=&lt;ID=*,Description="Represents allele(s) other than observed."&gt;
##INFO=&lt;ID=INDEL,Number=0,Type=Flag,Description="Indicates that the variant is an INDEL."&gt;
##INFO=&lt;ID=IDV,Number=1,Type=Integer,Description="Maximum number of raw reads supporting an indel"&gt;
##INFO=&lt;ID=IMF,Number=1,Type=Float,Description="Maximum fraction of raw reads supporting an indel"&gt;
##INFO=&lt;ID=DP,Number=1,Type=Integer,Description="Raw read depth"&gt;
##INFO=&lt;ID=VDB,Number=1,Type=Float,Description="Variant Distance Bias for filtering splice-site artefacts in RNA-seq data (bigger is better)",Version="3"&gt;
##INFO=&lt;ID=RPBZ,Number=1,Type=Float,Description="Mann-Whitney U-z test of Read Position Bias (closer to 0 is better)"&gt;
##INFO=&lt;ID=MQBZ,Number=1,Type=Float,Description="Mann-Whitney U-z test of Mapping Quality Bias (closer to 0 is better)"&gt;
##INFO=&lt;ID=BQBZ,Number=1,Type=Float,Description="Mann-Whitney U-z test of Base Quality Bias (closer to 0 is better)"&gt;
##INFO=&lt;ID=MQSBZ,Number=1,Type=Float,Description="Mann-Whitney U-z test of Mapping Quality vs Strand Bias (closer to 0 is better)"&gt;
##INFO=&lt;ID=NMBZ,Number=1,Type=Float,Description="Mann-Whitney U-z test of Number of Mismatches within supporting reads (closer to 0 is better)"&gt;
##INFO=&lt;ID=SCBZ,Number=1,Type=Float,Description="Mann-Whitney U-z test of Soft-Clip Length Bias (closer to 0 is better)"&gt;
##INFO=&lt;ID=FS,Number=1,Type=Float,Description="Phred-scaled p-value using Fisher's exact test to detect strand bias"&gt;
##INFO=&lt;ID=SGB,Number=1,Type=Float,Description="Segregation based metric."&gt;
##INFO=&lt;ID=MQ0F,Number=1,Type=Float,Description="Fraction of MQ0 reads (smaller is better)"&gt;
##FORMAT=&lt;ID=PL,Number=G,Type=Integer,Description="List of Phred-scaled genotype likelihoods"&gt;
##FORMAT=&lt;ID=GT,Number=1,Type=String,Description="Genotype"&gt;
##INFO=&lt;ID=AC,Number=A,Type=Integer,Description="Allele count in genotypes for each ALT allele, in the same order as listed"&gt;
##INFO=&lt;ID=AN,Number=1,Type=Integer,Description="Total number of alleles in called genotypes"&gt;
##INFO=&lt;ID=DP4,Number=4,Type=Integer,Description="Number of high-quality ref-forward , ref-reverse, alt-forward and alt-reverse bases"&gt;
##INFO=&lt;ID=MQ,Number=1,Type=Integer,Description="Average mapping quality"&gt;
##bcftools_callVersion=1.16+htslib-1.17
##bcftools_callCommand=call -mv -Ov -o results/VCF_Files/RNA_S10_merged.vcf; Date=Mon Jun 19 10:48:17 2023
#CHROM  POS ID  REF ALT QUAL    FILTER  INFO    FORMAT  Data_for_VCF_analysis/RNA_S10_merged.bam
1   33218   .   G   A   65.3262 .   DP=88;VDB=0.0923504;SGB=-0.692914;RPBZ=3.99376;MQBZ=-1.86933;MQSBZ=-0.901828;BQBZ=-1.8368;SCBZ=2.6559;FS=0;MQ0F=0;AC=1;AN=2;DP4=15,13,16,9;MQ=19    GT:PL   0/1:98,0,138
1   33222   .   C   G   69.1967 .   DP=56;VDB=4.89382e-06;SGB=-0.692352;RPBZ=3.47069;MQBZ=-1.73535;MQSBZ=-0.222384;BQBZ=-1.36705;SCBZ=2.16882;FS=0;MQ0F=0;AC=1;AN=2;DP4=18,13,12,9;MQ=19    GT:PL   0/1:102,0,138
1   33223   .   T   G   61.1405 .   DP=56;VDB=2.99077e-05;SGB=-0.692067;RPBZ=3.40644;MQBZ=-1.80665;MQSBZ=-0.222384;BQBZ=0.830878;SCBZ=2.63256;FS=0;MQ0F=0;AC=1;AN=2;DP4=18,14,12,8;MQ=19    GT:PL   0/1:94,0,132
1   33224   .   T   G   65.1016 .   DP=58;VDB=4.85907e-06;SGB=-0.692352;RPBZ=3.67489;MQBZ=-1.78978;MQSBZ=-0.159627;BQBZ=-1.43699;SCBZ=2.60016;FS=0;MQ0F=0;AC=1;AN=2;DP4=18,15,12,9;MQ=19    GT:PL   0/1:98,0,144
1   33225   .   G   T   64.0746 .   DP=58;VDB=4.36523e-06;SGB=-0.692352;RPBZ=3.67489;MQBZ=-1.78978;MQSBZ=-0.159627;BQBZ=-2.60059;SCBZ=2.60016;FS=0;MQ0F=0;AC=1;AN=2;DP4=18,15,12,9;MQ=19    GT:PL   0/1:97,0,144
1   33227   .   T   A   64.067  .   DP=59;VDB=4.09235e-06;SGB=-0.692352;RPBZ=4.13393;MQBZ=-1.81637;MQSBZ=-0.18317;BQBZ=-1.48941;SCBZ=2.64866;FS=0;MQ0F=0;AC=1;AN=2;DP4=19,15,12,9;MQ=19 GT:PL   0/1:97,0,144
1   49149   .   C   T   30.4183 .   DP=4;VDB=0.0058656;SGB=-0.556411;FS=0;MQ0F=0;AC=2;AN=2;DP4=0,0,0,4;MQ=20    GT:PL   1/1:60,12,0
1   83968   .   C   G   78.0347 .   DP=10;VDB=5.52906e-06;SGB=-0.662043;RPBZ=-3;MQBZ=0;MQSBZ=0;BQBZ=-0.333333;SCBZ=1.77187;FS=0;MQ0F=0;AC=2;AN=2;DP4=1,0,2,7;MQ=20  GT:PL   1/1:105,10,0
1   83970   .   T   C   78.0347 .   DP=10;VDB=8.25997e-06;SGB=-0.662043;RPBZ=-1.79284;MQBZ=0;MQSBZ=0;BQBZ=0;SCBZ=1.77187;FS=0;MQ0F=0;AC=2;AN=2;DP4=1,0,2,7;MQ=20    GT:PL   1/1:105,10,0
1   83972   .   G   T   78.0347 .   DP=10;VDB=8.25997e-06;SGB=-0.662043;RPBZ=-1.79284;MQBZ=0;MQSBZ=0;BQBZ=0;SCBZ=1.57628;FS=0;MQ0F=0;AC=2;AN=2;DP4=1,0,2,7;MQ=20    GT:PL   1/1:105,10,0
1   83975   .   G   A   78.0347 .   DP=10;VDB=1.22485e-05;SGB=-0.662043;RPBZ=-1.79284;MQBZ=0;MQSBZ=0;BQBZ=0;SCBZ=1.57628;FS=0;MQ0F=0;AC=2;AN=2;DP4=1,0,2,7;MQ=20    GT:PL   1/1:105,10,0
1   174956  .   C   T   10.7923 .   DP=2;VDB=0.14;SGB=-0.453602;MQSBZ=0;FS=0;MQ0F=0;AC=2;AN=2;DP4=0,0,1,1;MQ=20 GT:PL   1/1:40,6,0
1   175456  .   A   G   7.30814 .   DP=2;VDB=0.02;SGB=-0.453602;FS=0;MQ0F=0;AC=2;AN=2;DP4=0,0,2,0;MQ=20 GT:PL   1/1:36,6,0
1   211292  .   A   T   16.7427 .   DP=5;VDB=0.0058656;SGB=-0.556411;RPBZ=-2;MQBZ=0;MQSBZ=0;BQBZ=1.22474;SCBZ=2;FS=0;MQ0F=0;AC=1;AN=2;DP4=0,1,4,0;MQ=20 GT:PL   0/1:47,0,5
1   321659  .   G   A   13.5525 .   DP=7;VDB=0.107235;SGB=-0.511536;RPBZ=1.34164;MQBZ=0;MQSBZ=0;BQBZ=1.73205;SCBZ=0.942809;FS=0;MQ0F=0;AC=1;AN=2;DP4=1,0,1,2;MQ=20  GT:PL   0/1:45,0,8
1   321661  .   A   C   13.5525 .   DP=7;VDB=0.107235;SGB=-0.511536;RPBZ=1.34164;MQBZ=0;MQSBZ=0;BQBZ=1.73205;SCBZ=0.942809;FS=0;MQ0F=0;AC=1;AN=2;DP4=1,0,1,2;MQ=20  GT:PL   0/1:45,0,8
1   323166  .   G   A   7.30814 .   DP=4;VDB=0.1;SGB=-0.453602;FS=0;MQ0F=0;AC=2;AN=2;DP4=0,0,0,2;MQ=20  GT:PL   1/1:36,6,0
1   331785  .   A   T   7.30814 .   DP=2;VDB=0.02;SGB=-0.453602;FS=0;MQ0F=0;AC=2;AN=2;DP4=0,0,2,0;MQ=20 GT:PL   1/1:36,6,0
1   331890  .   C   T   39.4149 .   DP=6;VDB=0.100421;SGB=-0.556411;MQSBZ=0;FS=0;MQ0F=0;AC=2;AN=2;DP4=0,0,3,1;MQ=20 GT:PL   1/1:69,12,0</code></pre>
</div>
</div>
<p>Next, in order to generate plots of the metrics stored in the VCF files, we will first import the VCF files in Python using the <code>scikit-allel</code> package. This package contains a series of function helpful for processing variant calling files. <br> For now, we will import only the VCF files generated using the Hifi data alignments. You can ignore the warning.</p>
<div id="cell-29" class="cell" data-outputid="bfe98aaa-e71a-407e-8c7e-3f38090f8574" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Import the VCF files</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>Hifi_Contig_1_vcf <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/HIFI_Contig_1.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>Hifi_Contig_2_vcf <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/HIFI_Contig_2.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>Hifi_Contig_1_2_vcf <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/HIFI_Contig_1_2.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/work/Course_Env/lib/python3.10/site-packages/allel/io/vcf_read.py:1732: UserWarning: invalid INFO header: '##INFO=&lt;ID=VDB,Number=1,Type=Float,Description="Variant Distance Bias for filtering splice-site artefacts in RNA-seq data (bigger is better)",Version="3"&gt;\n'
  warnings.warn('invalid INFO header: %r' % header)</code></pre>
</div>
</div>
<p>Let‚Äôs check the number of SNPs in each of the three VCF files.</p>
<p>The first two VCF files contain subgenome SNPs. You can see that we identified a have a high number of polymorphisms between the two subgenomes. On the other hand the Hifi_Contig1_2_vcf file contains what we would call false positives, as we called SNPs using the same Hifi reads that were used for assembling the reference genome. As expected the number of SNPs in this file is much smaller.</p>
<div id="cell-31" class="cell" data-outputid="9addd257-5ec9-472d-a609-95a6fed658fc" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in Hifi Contig 1 vcf file:"</span>, Hifi_Contig_1_vcf[<span class="st">'variants/POS'</span>].size)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in Hifi Contig 2 vcf file:"</span>, Hifi_Contig_2_vcf[<span class="st">'variants/POS'</span>].size)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in Hifi Contig 1 and 2 vcf file:"</span>, Hifi_Contig_1_2_vcf[<span class="st">'variants/POS'</span>].size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of SNPs in Hifi Contig 1 vcf file: 31981
Number of SNPs in Hifi Contig 2 vcf file: 30823
Number of SNPs in Hifi Contig 1 and 2 vcf file: 1309</code></pre>
</div>
</div>
<p>As an overview of the distribution of SNPs, we can plot the density of SNPs across the contigs. We have defined a function called <code>plot_variant_density</code> in the file <code>../Scripts/pythonScripts.sh</code> that does exactly that. We use that to plot the SNP density across the contigs in the three VCF files in bins of 5000 bp.</p>
<p>We can approximate that a SNP density of 0.1 SNPs/bp repesents one polymorphic site at every ten nucleotides. You can see that for the two contigs there are regions more conserved between the two subgenomes, which show a low density of SNPs and more variable regions, which have a higher SNP density.</p>
<p>In the third plot we can mainly observe SNPs at the beging of the contigs, as you have probably also oberved when inspecting the files in IGV. Taking a look at the scale of the y-axis you can oberve that the SNP density for <code>Hifi_Contig1_2_vcf</code> is much smaller compared to the other two files.</p>
<p>Note: For easier plotting of the files that contain SNPs from both Contig 1 and 2, the SNP density is plotted as an overlay of both contigs.</p>
<div id="cell-33" class="cell" data-outputid="c1cd00a6-c009-49be-c435-49122ed8b9b5" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot SNP density</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>plot_variant_density(Hifi_Contig_1_vcf, window_size<span class="op">=</span><span class="dv">5000</span>, title<span class="op">=</span><span class="st">'Contig 1 Raw SNP density'</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>plot_variant_density(Hifi_Contig_2_vcf, window_size<span class="op">=</span><span class="dv">5000</span>, title<span class="op">=</span><span class="st">'Contig 2 Raw SNP density'</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>plot_variant_density(Hifi_Contig_1_2_vcf, window_size<span class="op">=</span><span class="dv">5000</span>, title<span class="op">=</span><span class="st">'Contig 1 and 2 Raw SNP density'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="vcf_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="vcf_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="vcf_files/figure-html/cell-12-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can also plot some of the most relevant parameters from the VCF files, such as the read depth and the quality, to have an overview of the quality of the SNPs in these samples. We defined for that the function <code>plot_variant_hist</code> in the file <code>../Scripts/pythonScripts.sh</code>.</p>
<p>We can plot the metrics ‚ÄúDP‚Äù (Read depth), ‚ÄúQUAL‚Äù (Quality score), and ‚ÄúMQ‚Äù (Mapping quality for <code>Hifi_Contig1_vcf</code>. The x-axis represents the chosen metric, while the y-axis represents the number of SNPs. You can observe that the majority of the SNPs from this file have a high quality.</p>
<div id="cell-36" class="cell" data-outputid="0d82a668-e8da-45f8-fc02-4cc404e75d79" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>plot_variant_hist(Hifi_Contig_1_vcf,<span class="st">'DP'</span>, <span class="st">"mediumblue"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>plot_variant_hist(Hifi_Contig_1_vcf, <span class="st">'QUAL'</span>, <span class="st">"forestgreen"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>plot_variant_hist(Hifi_Contig_1_vcf, <span class="st">'MQ'</span>, <span class="st">"darkred"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="vcf_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="vcf_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="vcf_files/figure-html/cell-13-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="alert-success">
<font size="+2"> <b> TASK </b> </font>
</div>
<ul>
<li><p>In the two cells below generate the same three plots as above using the VCF files for Contig 2 and Contig 1+2.</p></li>
<li><p>You will just need to copy the three command lines from the cell above and replace the name of the VCF files.</p></li>
</ul>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the metrics for Contig 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-39" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the metrics for Contig 1 + 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can observe in the plots above, there are some positions with very low read depth and low quality. Those might represent false-positive variants. Thus, we will filter the VCF files in order to eliminate those positions. <br> For this purpose, we will use another <code>bcftools</code> function <code>bcftools filter</code>. We can pass thresholds for all the info metrics to this function using the ‚Äú-i‚Äù flag. Below is just an example of the thresholds, you can change the values to suit your files. <br> Note that this command will generate a new filtered VCF file in the ‚ÄúVCF_Files‚Äù Folder.</p>
<div id="cell-41" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span> <span class="op">-</span>i <span class="st">'(QUAL&gt;150) &amp; (DP &gt; 20) &amp; (MQ &gt; 40)'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1.vcf <span class="op">-</span>O v <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_filtered.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span> <span class="op">-</span>i <span class="st">'(QUAL&gt;150) &amp; (DP &gt; 20) &amp; (MQ &gt; 40)'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2.vcf <span class="op">-</span>O v <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2_filtered.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-43" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span> <span class="op">-</span>i <span class="st">'(QUAL&gt;150) &amp; (DP &gt; 20) &amp; (MQ &gt; 40)'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_2.vcf <span class="op">-</span>O v <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_2_filtered.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>We read the filtered VCF file for Contig1 in python and generate the same plots as before. We can read the VCF file and generate all the plots in one cell this time.</p>
<p>We check how many positions have been eliminated by the filter and compare the plots with the ones for the unfiltered VCFs.</p>
<p>If you consider that there are still positions with with low quality you can change the filter and repeat the process.</p>
<div id="cell-45" class="cell" data-outputid="a51726b7-4a4a-4527-cf90-b0b722a5ec05" data-tags="[]">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>Hifi_Contig1_filtered <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/HIFI_Contig_1_filtered.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in Contig 1 VCF filtered file:"</span>, Hifi_Contig1_filtered[<span class="st">'variants/POS'</span>].size)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot SNP density</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>plot_variant_density(Hifi_Contig1_filtered, window_size<span class="op">=</span><span class="dv">5000</span>, title<span class="op">=</span><span class="st">'Contig 1 Filtered variant density'</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot metrics</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>plot_variant_hist(Hifi_Contig1_filtered,<span class="st">'DP'</span>,  <span class="st">"mediumblue"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>plot_variant_hist(Hifi_Contig1_filtered, <span class="st">'QUAL'</span>,  <span class="st">"forestgreen"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>plot_variant_hist(Hifi_Contig1_filtered, <span class="st">'MQ'</span>, <span class="st">"darkred"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="alert-success">
<font size="+2"> <b> TASK </b> </font>
</div>
<p><strong>This exercise covers the rest of the notebook and contains explanations as well</strong>. The code will work only if you complete correctly the empty cells. Some cells are filled in to help.</p>
<ul>
<li>Compare the VCF files before and after filtering in IGV. In the two cells below generate the same plots as above using the filtered VCF files for Contig 2 and Contig 1 + 2. You will just need to copy the three command lines from the cell above and replace the name of the VCF files.</li>
</ul>
<div id="cell-47" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Figures for Contig 2 Filtered VCF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Figures for Contig 1 + 2 Filtered VCF</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Repeat the quality check and filtering as described above for the two RNA-seq VCF files:</li>
</ul>
<p>Read the VCF files in Python:</p>
<div id="cell-51" class="cell" data-outputid="e9d2ea81-5fc4-4157-be80-7a667d4517f1" data-tags="[]">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>vcf_S10_RNA <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/RNA_S10_merged.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>vcf_Ti_RNA <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/RNA_TI_merged.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Print the number of SNPs in the two RNA-seq VCF files. Note that the number of SNPs is much smaller than for the Hifi VCF files. Also, there is a difference in the number of SNPs for the two genotypes. As S10 RNA-seq data originates from the same genotype as the referece genome, one would expect a small number of SNPs to be identified in this case.</p>
<div id="cell-53" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in S10 RNA-seq VCF file:"</span>, vcf_S10_RNA[<span class="st">'variants/POS'</span>].size)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in Ti RNA-seq VCF file:"</span>, vcf_Ti_RNA[<span class="st">'variants/POS'</span>].size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Generate SNP density plots using the plot_variant_density() function:</p>
<p>Generate info histograms using the plot_variant_hist() function for the same fields. You should observe that the metrics for the RNA-seq vcf files are quite different from the ones using Hifi reads.</p>
<p>Filter the VCF files using <code>bcftools</code> and your selected tresholds after inspecting the VCF files. <strong>Add the filter thresholds before running the command.</strong></p>
<div id="cell-61" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span> <span class="op">-</span>i <span class="st">'add filter thresholds here'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_S10_merged.vcf <span class="op">-</span>O v <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_S10_merged_filtered.vcf</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span> <span class="op">-</span>i <span class="st">'add filter thresholds here'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged.vcf <span class="op">-</span>O v <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Read the filtered VCFs in python:</p>
<div id="cell-63" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>vcf_S10_RNA_filtered <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/RNA_S10_merged_filtered.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>vcf_Ti_RNA_filtered <span class="op">=</span> allel.read_vcf(<span class="st">'results/VCF_Files/RNA_TI_merged_filtered.vcf'</span>, fields<span class="op">=</span><span class="st">'*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the number of SNPs in the filtered VCF files:</p>
<div id="cell-65" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in the filtered S10 RNA-seq VCF file:"</span>, vcf_S10_RNA_filtered[<span class="st">'variants/POS'</span>].size)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of SNPs in the filtered Ti RNA-seq VCF file:"</span>, vcf_Ti_RNA_filtered[<span class="st">'variants/POS'</span>].size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot same histograms for the filtered VCF files.</p>
<ul>
<li>Question: Is it relevant to filter for false positives in this case, and what parameters would you look further into?</li>
</ul>
</section>
<section id="genotypes-counting" class="level1">
<h1>Genotypes counting</h1>
<p>We want to count the different genotypes in each of the five filtered VCF files generated previously. To make this task easier we can take advantage of the counting functions in the <code>scikit-allel</code> package. We have used those to implement a little function called <code>position_count</code> in the file <code>../Scripts/pythonScripts.sh</code>.</p>
<ul>
<li>You can then use the function with each of the 5 filtered VCF files to count the number of positions. You need to fill the names of the VCF files imported in Python.</li>
</ul>
<div id="cell-73" class="cell" data-outputid="03c3e06a-8dd3-432f-eb19-95e53d91e167" data-tags="[]">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Contig 1 filtered VCF</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>position_count(Hifi_Contig1_filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell" data-outputid="844c863e-8e3e-4986-e000-70d2e58d52ad">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Contig 2 filtered VCF</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>position_count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Contig 1 and 2 filtered VCF</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>position_count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#RNAseq S10 filtered VCF</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>position_count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#RNAseq Ti filtered VCF</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>position_count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="comparison-of-vcf-files" class="level1">
<h1>Comparison of VCF files</h1>
<p>Compare the VCF files with subgenome variants and the VCF files with S10/Tienshan genotype specific variants obtained from RNA-seq mapping</p>
<p>We want now to find overlapping position between the Contig 1 and Contig 2 Hifi VCF files and the Ti RNAseq VCF file.</p>
<p>To ease this task we will first create two merged VCF files containing:</p>
<ul>
<li>Hifi Contig 1 VCF + Ti RNAseq VCF</li>
<li>Hifi Contig 2 VCF + Ti RNAseq VCF</li>
</ul>
<p>Once again, we will use <code>bcftools</code> for this task, using the merge function. However, the <code>bcftools merge</code> function works only with compressed and indexed VCF files, so first we will do this.</p>
<div id="cell-81" class="cell" data-outputid="2397816a-53ea-47fb-8aaa-c199a5ee919d" data-tags="[]">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools view results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_filtered.vcf <span class="op">-</span>Oz <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_filtered.vcf.gz</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools index results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_filtered.vcf.gz <span class="op">-</span>f <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_filtered.vcf.gz.csi</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools view results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2_filtered.vcf <span class="op">-</span>Oz <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2_filtered.vcf.gz</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools index results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2_filtered.vcf.gz <span class="op">-</span>f <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2_filtered.vcf.gz.csi</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools view results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf <span class="op">-</span>Oz <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf.gz</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools index results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf.gz <span class="op">-</span>f <span class="op">-</span>o results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf.gz.csi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can merge Contig 1 VCF with the Ti RNA VCF and keep only positions that match between the two files by filtering out any positions with missing genotypes.</p>
<div id="cell-83" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools merge results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_1_filtered.vcf.gz results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf.gz <span class="op">|</span> bcftools <span class="bu">filter</span> <span class="op">-</span>e <span class="st">'GT="./."'</span> <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_1_merged.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge Contig 2 VCF with the Ti RNA VCF and keep only positions that match between the two files.</p>
<div id="cell-85" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools merge results<span class="op">/</span>VCF_Files<span class="op">/</span>HIFI_Contig_2_filtered.vcf.gz results<span class="op">/</span>VCF_Files<span class="op">/</span>RNA_TI_merged_filtered.vcf.gz <span class="op">|</span> bcftools <span class="bu">filter</span> <span class="op">-</span>e <span class="st">'GT="./."'</span> <span class="op">&gt;</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_2_merged.vcf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Take a look at the merged VCF file. <br> You can see that compared with the VCF files for just one sample, there is now a new column in the file, with the corresponding genotype for the second sample that we merged.</p>
<div id="cell-87" class="cell" data-outputid="0f084879-0d21-43ec-a691-596fd40c4952" data-tags="[]">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>cat results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_1_merged.vcf <span class="op">|</span> head <span class="op">-</span><span class="dv">50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to count the genotypes for the matching positions we can use once again <code>bcftools filter</code> command. Only that this time we will filter based on the genotype columns for the two samples (GT[0] and GT[1]). GT[0] repesents the genotype for the first sample in the merge command and GT[1] is the genotype for the second sample in the merge command.</p>
<ul>
<li>AR - heterozygous</li>
<li>AA - homozygous alternate</li>
</ul>
<p>For example, the filter <code>GT[0]="AR" &amp;&amp; GT[1]="AR"</code> will keep only position in which both samples have a heterozygous genotype. A quick way to count how many positions are in the VCF file is by suing the simple bash command <code>grep</code>. This will count all the lines in the VCF files that do not start with a <code>#</code>, thus all the data lines.</p>
<div id="cell-89" class="cell" data-outputid="0e6347cc-1def-4de1-f2d3-e87e54e40277" data-tags="[]">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>echo <span class="st">"AR + AR:"</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span>  <span class="op">-</span>i <span class="st">'GT[0]="AR" &amp;&amp; GT[1]="AR"'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_1_merged.vcf <span class="op">|</span> grep <span class="op">-</span>c <span class="op">-</span>v <span class="st">"^#"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>echo <span class="st">"AR + AA:"</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span>  <span class="op">-</span>i <span class="st">'GT[0]="AR" &amp;&amp; GT[1]="AA"'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_1_merged.vcf <span class="op">|</span> grep <span class="op">-</span>c <span class="op">-</span>v <span class="st">"^#"</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>echo <span class="st">"AA + AR:"</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span>  <span class="op">-</span>i <span class="st">'GT[0]="AA" &amp;&amp; GT[1]="AR"'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_1_merged.vcf <span class="op">|</span> grep <span class="op">-</span>c <span class="op">-</span>v <span class="st">"^#"</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>echo <span class="st">"AA + AA:"</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bcftools <span class="bu">filter</span>  <span class="op">-</span>i <span class="st">'GT[0]="AA" &amp;&amp; GT[1]="AA"'</span> results<span class="op">/</span>VCF_Files<span class="op">/</span>TI_Contig_1_merged.vcf <span class="op">|</span> grep <span class="op">-</span>c <span class="op">-</span>v <span class="st">"^#"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Use the same commands as above to count the positions marching the filters in the Contig2_Ti_merged.vcf.</li>
</ul>
</section>
<section id="wrapping-up" class="level1">
<h1>Wrapping up üéâ üéâ üéâ</h1>
<p>In this exercise, you identified polymorphisms between the two white clover subgenomes using Hifi reads alignment files and SNPs specific for the white clover Tienshan genotype using RNA-seq alignment files. You learned how to import VCF files in Python to extract data and created plots. You also filtered low-quality variants from the VCF files and counted genotypes.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/hds-sandbox\.github\.io\/NGS_summer_course_Aarhus\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>